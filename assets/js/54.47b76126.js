(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{342:function(s,t,a){"use strict";a.r(t);var r=a(10),e=Object(r.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"复制功能"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#复制功能"}},[s._v("#")]),s._v(" 复制功能")]),s._v(" "),t("blockquote",[t("p",[s._v("解决数据库的读负载")])]),s._v(" "),t("h3",{attrs:{id:"二进制日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二进制日志"}},[s._v("#")]),s._v(" 二进制日志")]),s._v(" "),t("blockquote",[t("p",[s._v("记录了所用对mysql数据库的修改时间，包括增删改事件，对表结构修改的事件")])]),s._v(" "),t("ol",[t("li",[s._v("查看工具 binlog")]),s._v(" "),t("li",[s._v("参数\n"),t("ol",[t("li",[s._v("binlog_format (row:安全，保证数据一致;statement:占用空间小)")]),s._v(" "),t("li",[s._v("binlog_row_image (full|minimal)")])])])]),s._v(" "),t("h3",{attrs:{id:"基于行的复制-rbr"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基于行的复制-rbr"}},[s._v("#")]),s._v(" 基于行的复制（RBR）")]),s._v(" "),t("blockquote",[t("p",[s._v("日志格式为row，基于记录值的修改值进行")])]),s._v(" "),t("ol",[t("li",[s._v("避免锁")]),s._v(" "),t("li",[s._v("避免由于不确定值函数产生的值")])]),s._v(" "),t("h3",{attrs:{id:"基于sql语句的复制-sbr"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基于sql语句的复制-sbr"}},[s._v("#")]),s._v(" 基于sql语句的复制（SBR）")]),s._v(" "),t("blockquote",[t("p",[s._v("日志使用statement格式")])]),s._v(" "),t("h3",{attrs:{id:"工作方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#工作方式"}},[s._v("#")]),s._v(" 工作方式")]),s._v(" "),t("ol",[t("li",[s._v("主服务器将变更写入二进制日志（默认未开启）")]),s._v(" "),t("li",[s._v("从服务器读取主服务器的二进制变更到relay_log中")]),s._v(" "),t("li",[s._v("从服务器重放relay_log中的日志")])]),s._v(" "),t("h3",{attrs:{id:"基于日志点主从复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基于日志点主从复制"}},[s._v("#")]),s._v(" 基于日志点主从复制")]),s._v(" "),t("ol",[t("li",[s._v("主服务器配置")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("#mysql master1 config \n[mysqld]\nserver-id = 1        # 节点ID，确保唯一\n\n# log config\nlog-bin = mysql-bin     #开启mysql的binlog日志功能\nsync_binlog = 1         #控制数据库的binlog刷到磁盘上去 , 0 不控制，性能最好，1每次事物提交都会刷到日志文件中，性能最差，最安全\nbinlog_format = mixed   #binlog日志格式，mysql默认采用statement，建议使用mixed\nexpire_logs_days = 7                           #binlog过期清理时间\nmax_binlog_size = 100m                    #binlog每个日志文件大小\nbinlog_cache_size = 4m                        #binlog缓存大小\nmax_binlog_cache_size= 512m              #最大binlog缓存大\nbinlog-ignore-db=mysql #不生成日志文件的数据库，多个忽略数据库可以用逗号拼接，或者 复制这句话，写多行\n\nauto-increment-offset = 1     # 自增值的偏移量\nauto-increment-increment = 1  # 自增值的自增量\nslave-skip-errors = all #跳过从库错误\n")])])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("从数据库配置")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("[mysqld]\nserver-id = 2\nlog-bin=mysql-bin\nrelay-log = mysql-relay-bin\nreplicate-wild-ignore-table=mysql.%\nreplicate-wild-ignore-table=test.%\nreplicate-wild-ignore-table=information_schema.%\n")])])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("主服务器创建用户并且授权")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" repl_user IDENTIFIED "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl_passwd'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'ip段'")]),s._v(" identified "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'password'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 授权")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("grant")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("replication")]),s._v(" slave "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl_user'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'172.17.0.2'")]),s._v("  identified "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl_passwd'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 刷新权限")]),s._v("\nFLUSH "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIVILEGES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查看 master状态")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" master "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nmysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" master "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("------------------+----------+--------------+------------------+-------------------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("File")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Position "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Binlog_Do_DB "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Binlog_Ignore_DB "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Executed_Gtid_Set "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("------------------+----------+--------------+------------------+-------------------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("000005")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("120")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mysql            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("------------------+----------+--------------+------------------+-------------------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" sec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("ol",{attrs:{start:"4"}},[t("li",[s._v("配置从服务器")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" CHANGE MASTER "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" \nMASTER_HOST "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'172.17.0.3'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  \nMASTER_USER "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl_user'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \nMASTER_PASSWORD "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl_passwd'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nMASTER_PORT "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3307")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nMASTER_LOG_FILE"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.000005'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nMASTER_LOG_POS"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("120")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nMASTER_RETRY_COUNT "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nMASTER_HEARTBEAT_PERIOD "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# MASTER_LOG_FILE='mysql-bin.000005',#与主库File 保持一致")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# MASTER_LOG_POS=120 , #与主库Position 保持一致")]),s._v("\n")])])]),t("ol",{attrs:{start:"5"}},[t("li",[s._v("启动从库slave进程")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" slave "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nQuery OK"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rows")]),s._v(" affected "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.04")]),s._v(" sec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("ol",{attrs:{start:"6"}},[t("li",[s._v("查看从服务器状态")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" master "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h3",{attrs:{id:"基于gtid主从复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基于gtid主从复制"}},[s._v("#")]),s._v(" 基于GTID主从复制")]),s._v(" "),t("blockquote",[t("p",[s._v("大于 5.6 推荐 GTID复制模式")])]),s._v(" "),t("h2",{attrs:{id:"复制拓扑"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#复制拓扑"}},[s._v("#")]),s._v(" 复制拓扑")]),s._v(" "),t("h3",{attrs:{id:"一主多从"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一主多从"}},[s._v("#")]),s._v(" 一主多从")]),s._v(" "),t("h4",{attrs:{id:"合适使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#合适使用"}},[s._v("#")]),s._v(" 合适使用")]),s._v(" "),t("ol",[t("li",[s._v("不同业务使用不同的从库")]),s._v(" "),t("li",[s._v("灾难恢复功能")]),s._v(" "),t("li",[s._v("分担主库的读负载")])]),s._v(" "),t("h3",{attrs:{id:"主主复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主主复制"}},[s._v("#")]),s._v(" 主主复制")]),s._v(" "),t("h4",{attrs:{id:"注意"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#注意"}},[s._v("#")]),s._v(" 注意")]),s._v(" "),t("ol",[t("li",[s._v("容易造成数据冲突")]),s._v(" "),t("li",[s._v("不同的主库中操作不同的表。")]),s._v(" "),t("li",[s._v("使用两个参数控制，自增id\n"),t("ol",[t("li",[s._v("auto_increment_increment = 2 (自增id每次增加2)")]),s._v(" "),t("li",[s._v("auto_increment_offset = 1|2 (自增id分别使用1或2)")])])])]),s._v(" "),t("h3",{attrs:{id:"主主复制-主备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主主复制-主备"}},[s._v("#")]),s._v(" 主主复制（主备）")]),s._v(" "),t("blockquote",[t("p",[s._v("每次只会对外公布一台服务器")])]),s._v(" "),t("h3",{attrs:{id:"级联复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#级联复制"}},[s._v("#")]),s._v(" 级联复制")]),s._v(" "),t("blockquote",[t("p",[s._v("当从库过多，会对主库造成过大的复制压力； 创建分发主库，实际也是从库，记录主库传递过来的二进制，传递给其它从库，slave_log_updates")])]),s._v(" "),t("h2",{attrs:{id:"高可用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#高可用"}},[s._v("#")]),s._v(" 高可用")]),s._v(" "),t("blockquote",[t("p",[s._v("以系统的不可用时间长短来衡量")])]),s._v(" "),t("h3",{attrs:{id:"mmm架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mmm架构"}},[s._v("#")]),s._v(" MMM架构")]),s._v(" "),t("blockquote",[t("p",[s._v("监控和管理mysql的主主复制拓扑，并在当前的主服务器失效时，进行主服务器和主备服务器之间进行切换和故障转移等工作。")])]),s._v(" "),t("h3",{attrs:{id:"mhaj架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mhaj架构"}},[s._v("#")]),s._v(" MHAj架构")]),s._v(" "),t("h3",{attrs:{id:"负载均衡和读写分离"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡和读写分离"}},[s._v("#")]),s._v(" 负载均衡和读写分离")]),s._v(" "),t("blockquote",[t("p",[s._v("使用基于mysql-proxy衍生的maxScale。")])]),s._v(" "),t("ol",[t("li",[s._v("使用中间件，是根据查询语句的分析，自动完成读写分离")]),s._v(" "),t("li",[s._v("对于程序透明，已有程序不用做任何修改")]),s._v(" "),t("li",[s._v("造成查询效率有很大损耗（50%~70%）")])]),s._v(" "),t("h3",{attrs:{id:"参考文档"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考文档"}},[s._v("#")]),s._v(" 参考文档")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://www.jianshu.com/p/19cb0f16dea4",target:"_blank",rel:"noopener noreferrer"}},[s._v("mysql实现主从复制/主从同步"),t("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=e.exports}}]);